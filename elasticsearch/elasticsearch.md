# Elasticsearch - The Definitive Guide

## Overview

* Kibana
    * http://localhost:5601
    * Web UI for elasticsearch

```
Relational DB  ⇒ Databases ⇒ Tables ⇒ Rows      ⇒ Columns
Elasticsearch  ⇒ Indices   ⇒ Types  ⇒ Documents ⇒ Fields
```

### Installing (macOS)

```
brew install elasticsearch kibana logstash
kibana-plugin install x-pack
```

## Examples

```bash
curl -XPOST "http://localhost:9200/_shutdown"
# does not seem to work?


curl -XGET "http://localhost:9200/?pretty"
# {
#   "name": "FNAhp-l",
#   "cluster_name": "elasticsearch_eoinkelly",
#   "cluster_uuid": "5E5Aa-tVQxeMkb9SUQAtqA",
#   "version": {
#     "number": "5.5.0",
#     "build_hash": "260387d",
#     "build_date": "2017-06-30T23:16:05.735Z",
#     "build_snapshot": false,
#     "lucene_version": "6.6.0"
#   },
#   "tagline": "You Know, for Search"
# }


curl -XGET "http://localhost:9200/_cluster/health"
# {
#   "cluster_name": "elasticsearch_eoinkelly",
#   "status": "yellow",
#   "timed_out": false,
#   "number_of_nodes": 1,
#   "number_of_data_nodes": 1,
#   "active_primary_shards": 30,
#   "active_shards": 30,
#   "relocating_shards": 0,
#   "initializing_shards": 0,
#   "unassigned_shards": 30,
#   "delayed_unassigned_shards": 0,
#   "number_of_pending_tasks": 0,
#   "number_of_in_flight_fetch": 0,
#   "task_max_waiting_in_queue_millis": 0,
#   "active_shards_percent_as_number": 50
# }
```

# Getting started

* A node is an instance of ES
* node exposes Restful JSON API on port 9200
* nodes form a cluster on port 9300 (also what the java APIs use)
* is a document database
    * documents have fields
* by default every field in a document is indexed in an inverted index i.e. it is searchable
* uses JSON as the serialization format for documents
* storing a document in ES is called "indexing the document"
* A cluser is a group of nodes with the same vale of `cluster_name` (you can see this value via http://localhost:9200/)
* Java API has two clients
    1. Node client
        * your client joins the cluster as a "non data" node
        * it can forward requests to the node which does have the data
        * uses port 9300 and the native ES transport protocol
    1. Transport client
        * lighter weight
        * just forwards requests to the cluster
        * uses port 9300 and the native ES transport protocol

```
curl http://localhost:9200/
curl http://localhost:9200/_count
curl http://localhost:9200/_cluster/health

```

### Add a document

* use PUT when you have a document id you wnat to use.
* use POST to autogenerate a document id
    * Autogenerated IDs are 20 character long, URL-safe, Base64-encoded GUID strings.

The form of the URL is

```
PUT {index name}/{type name}/{document id}
POST {index name}/{type name}
```

Examples

```
# will autogenerate an document ID
POST /website/blog/
{
    "title": "My second blog entry",
    "text":  "Still trying this out...",
    "date":  "2014/01/01"
}

curl -XPUT 'localhost:9200/megacorp/employee/1?pretty' -H 'Content-Type: application/json' -d'
{
    "first_name" : "John",
    "last_name" :  "Smith",
    "age" :        25,
    "about" :      "I love to go rock climbing",
    "interests": [ "sports", "music" ]
}
'

# response
{
  "_index": "megacorp",
  "_type": "employee",
  "_id": "1",
  "_version": 1,
  "result": "created",
  "_shards": {
    "total": 2,
    "successful": 1,
    "failed": 0
  },
  "_seq_no": 0,
  "_primary_term": 1
}

```

### Retrieve a document

Form is GET /{index name}/{type name}/{document id}

```
curl -XGET "http://elasticsearch:9200/megacorp/employee/1"

{
  "_index": "megacorp",
  "_type": "employee",
  "_id": "1",
  "_version": 1,
  "found": true,
  "_source": {
    "first_name": "John",
    "last_name": "Smith",
    "age": 25,
    "about": "I love to go rock climbing",
    "interests": [
      "sports",
      "music"
    ]
  }
}
```

### Search within an index and type

* returns 10 results by default
* Form is `GET /{index name}/{type name}/_search`

```
GET /megacorp/employee/_search # return all documents of given index and type

GET /megacorp/employee/_search?q=last_name:Smith # filter those documents based on a field

# exaclty same as line above (but using the query DSL)
GET /megacorp/employee/_search
{
    "query" : {
        "match" : {
            "last_name" : "Smith"
        }
    }
}
```

Examples

```

curl -XGET "http://elasticsearch:9200/megacorp/employee/_search"


{
  "took": 2,
  "timed_out": false,
  "_shards": {
    "total": 5,
    "successful": 5,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 3,
    "max_score": 1,
    "hits": [
      {
        "_index": "megacorp",
        "_type": "employee",
        "_id": "2",
        "_score": 1,
        "_source": {
          "first_name": "Jane",
          "last_name": "Smith",
          "age": 32,
          "about": "I like to collect rock albums",
          "interests": [
            "music"
          ]
        }
      },
      {
        "_index": "megacorp",
        "_type": "employee",
        "_id": "1",
        "_score": 1,
        "_source": {
          "first_name": "John",
          "last_name": "Smith",
          "age": 25,
          "about": "I love to go rock climbing",
          "interests": [
            "sports",
            "music"
          ]
        }
      },
      {
        "_index": "megacorp",
        "_type": "employee",
        "_id": "3",
        "_score": 1,
        "_source": {
          "first_name": "Douglas",
          "last_name": "Fir",
          "age": 35,
          "about": "I like to build cabinets",
          "interests": [
            "forestry"
          ]
        }
      }
    ]
  }
}
```

# Chapter 2
# Chapter 3
# Chapter 4
# Chapter 5
# Chapter 6 - Mapping & Analysis


# Chapter 7
# Chapter 8
